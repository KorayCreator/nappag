<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nappag | Sosyal Akƒ±≈ü</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #007bff; --bg: #f0f2f5; --white: #ffffff; --gray: #65676b; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; color: #1c1e21; overflow-x: hidden; }
        nav { background: var(--white); height: 60px; display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #ddd; }
        .nav-inner { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .logo { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: 900; color: var(--blue); cursor: pointer; text-transform: uppercase; }
        
        .main-layout { display: flex; max-width: 1000px; margin: 0 auto; gap: 20px; padding: 15px; }
        .feed-side { flex: 1; min-width: 0; }
        .right-side { width: 300px; position: sticky; top: 75px; height: fit-content; }
        @media (max-width: 800px) { .main-layout { flex-direction: column; } .right-side { width: 100%; } }

        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; outline: none; }
        .btn-blue { background: var(--blue); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .admin-badge { color: var(--blue); margin-left: 5px; font-size: 14px; }
        .hashtag { color: var(--blue); font-weight: 600; cursor: pointer; }
        
        .actions { display: flex; gap: 8px; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .act-btn { flex: 1; background: #f0f2f5; border: none; padding: 8px; border-radius: 6px; font-weight: 600; color: var(--gray); cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .act-btn.active-l { color: var(--blue); }
        .act-btn.active-d { color: #f44336; }
        .comment-sec { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 13px; }

        .search-container { position: relative; margin-bottom: 15px; }
        #search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 100; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .search-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .trend-item { padding: 8px; cursor: pointer; border-radius: 6px; }
        .trend-item:hover { background: #f0f2f5; }

        #chat-ui { position: fixed; bottom: 0; right: 20px; width: 300px; height: 400px; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 0 15px rgba(0,0,0,0.2); z-index: 3000; display: none; flex-direction: column; }
        .chat-header { background: var(--blue); color: white; padding: 10px; display: flex; justify-content: space-between; border-radius: 10px 10px 0 0; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; background: #f0f2f5; display: flex; flex-direction: column; gap: 5px; }
        .m-me { background: var(--blue); color: white; align-self: flex-end; padding: 8px; border-radius: 10px; font-size: 12px; max-width: 80%; }
        .m-th { background: #e4e6eb; color: black; align-self: flex-start; padding: 8px; border-radius: 10px; font-size: 12px; max-width: 80%; }

        #profile-pg, #edit-pg { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 2000; display: none; overflow-y: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="auth-pg" style="max-width:350px; margin: 100px auto; padding: 20px;">
    <div class="card" style="text-align:center;">
        <h1 class="logo" style="font-size: 40px;">NAPPAG</h1>
        <input type="text" id="u-name" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="u-pass" placeholder="≈ûifre">
        <button class="btn-blue" onclick="handleAuth()">Giri≈ü Yap / Kaydol</button>
    </div>
</div>

<div id="main-pg" class="hidden">
    <nav><div class="nav-inner"><div class="logo" onclick="location.reload()">NAPPAG</div><div onclick="openUser(auth.currentUser.displayName)"><i class="fas fa-user-circle fa-2x" style="color:var(--blue); cursor:pointer;"></i></div></div></nav>
    <div class="main-layout">
        <div class="feed-side">
            <div class="card">
                <textarea id="inp" placeholder="Neler oluyor?"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="file" id="f-up" class="hidden" onchange="prevImg('p-img', 'f-up')">
                    <label for="f-up" style="color:var(--blue); cursor:pointer; font-weight:600;"><i class="fas fa-image"></i> G√∂rsel</label>
                    <button class="btn-blue" style="width:80px;" onclick="send()">Payla≈ü</button>
                </div>
                <img id="p-img" style="width:100%; display:none; border-radius:10px; margin-top:10px;">
            </div>
            <div id="posts-list"></div>
        </div>
        <div class="right-side">
            <div class="search-container">
                <input type="text" placeholder="üîç Kullanƒ±cƒ± ara..." oninput="searchUsers(this.value)" style="margin:0;">
                <div id="search-results" class="hidden"></div>
            </div>
            <div class="card">
                <h3 style="margin-top:0;"><i class="fas fa-fire" style="color:orange;"></i> G√ºndem</h3>
                <div id="trend-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="profile-pg">
    <nav><div class="nav-inner"><div class="logo" onclick="closeP()">‚Üê</div><b>PROFƒ∞L</b></div></nav>
    <div style="text-align:center; padding: 30px;">
        <img id="p-av" class="avatar" style="width:100px; height:100px; border:3px solid var(--blue)">
        <h2 id="p-un"></h2><p id="p-bi"></p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="edit-btn" class="btn-blue" style="width:auto; padding:8px 20px;" onclick="openEdit()">D√ºzenle</button>
            <button id="msg-btn" class="btn-blue" style="width:auto; padding:8px 20px;">Mesaj At</button>
        </div>
    </div>
    <div id="p-li" class="container" style="max-width:500px; margin:0 auto;"></div>
</div>

<div id="edit-pg">
    <nav><div class="nav-inner"><div class="logo" onclick="closeEdit()">‚úï</div><b>D√úZENLE</b></div></nav>
    <div style="max-width:400px; margin: 20px auto; padding:20px;">
        <img id="ed-av-prev" class="avatar" style="width:100px; height:100px; display:block; margin:0 auto;">
        <input type="file" id="f-av-edit" class="hidden" onchange="prevImg('ed-av-prev', 'f-av-edit')">
        <label for="f-av-edit" style="display:block; text-align:center; color:var(--blue); margin:15px; cursor:pointer;">Fotoƒürafƒ± Deƒüi≈ütir</label>
        <textarea id="ed-bio-inp" placeholder="Yeni bio..."></textarea>
        <button class="btn-blue" onclick="saveP()">Deƒüi≈üiklikleri Kaydet</button>
    </div>
</div>

<div id="chat-ui">
    <div class="chat-header"><span id="chat-title">Mesajlar</span><button onclick="document.getElementById('chat-ui').style.display='none'" style="color:white; background:none; border:none;">‚úï</button></div>
    <div id="chat-msgs" class="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:5px;"><input type="text" id="chat-inp" style="margin:0;"><button onclick="sendMsg()" class="btn-blue" style="width:auto;"><i class="fas fa-paper-plane"></i></button></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, setDoc, getDoc, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyBc1oohhXQFNr5QsoPG1VBc5lTMGaMoyos", authDomain: "nappag-8c527.firebaseapp.com", projectId: "nappag-8c527", storageBucket: "nappag-8c527.firebasestorage.app", messagingSenderId: "370496474734", appId: "1:370496474734:web:172774434cb14af279207f" };
    const app = initializeApp(cfg); const auth = getAuth(app); const db = getFirestore(app);
    let activeChat = null;

    onAuthStateChanged(auth, u => {
        document.getElementById('auth-pg').classList.toggle('hidden', u);
        document.getElementById('main-pg').classList.toggle('hidden', !u);
        if(u) {
            document.getElementById('inp').placeholder = `Neler oluyor ${u.displayName}?`;
            loadData();
        }
    });

    window.handleAuth = async () => {
        const n = document.getElementById('u-name').value.trim().toLowerCase(), p = document.getElementById('u-pass').value;
        if(!n || p.length < 6) return alert("Hata: Eksik bilgi veya kƒ±sa ≈üifre.");
        try { await signInWithEmailAndPassword(auth, n+"@nappag.com", p); }
        catch {
            const r = await createUserWithEmailAndPassword(auth, n+"@nappag.com", p);
            const pic = `https://ui-avatars.com/api/?name=${n}&background=007bff&color=fff`;
            await updateProfile(r.user, { displayName: n, photoURL: pic });
            await setDoc(doc(db, "users", n), { username: n, pic, bio: "Nappag kullanƒ±cƒ±sƒ±", ts: serverTimestamp() });
        }
    };

    window.send = async () => {
        const t = document.getElementById('inp').value, m = document.getElementById('p-img').src;
        if(!t && !m.includes('data')) return;
        const tags = t.match(/#\w+/g) || [];
        await addDoc(collection(db, "messages"), { t, n: auth.currentUser.displayName, p: auth.currentUser.photoURL, m: m.startsWith('data') ? m : "", ts: serverTimestamp(), likes: [], dislikes: [], comments: [], tags });
        document.getElementById('inp').value = ""; document.getElementById('p-img').style.display='none';
    };

    function loadData() {
        onSnapshot(query(collection(db, "messages"), orderBy("ts", "desc")), sn => {
            renderPosts(sn, "posts-list");
            updateTrends(sn);
        });
    }

    function renderPosts(sn, tid) {
        document.getElementById(tid).innerHTML = sn.docs.map(docSnap => {
            const d = docSnap.data(), id = docSnap.id, uid = auth.currentUser.uid;
            const isMe = (d.n === auth.currentUser.displayName);
            const badge = (d.n === "admin") ? '<i class="fas fa-check-circle admin-badge" title="Onaylƒ± Admin"></i>' : '';
            const comments = (d.comments || []).map(c => `<div><b>@${c.n}:</b> ${c.t}</div>`).join("");
            
            return `<div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openUser('${d.n}')">
                        <img src="${d.p}" class="avatar"> <b>@${d.n}${badge}</b>
                    </div>
                    ${isMe ? `<div>
                        <button onclick="editP('${id}',\`${d.t}\`)" style="border:none; background:none; color:var(--blue); cursor:pointer;"><i class="fas fa-edit"></i></button>
                        <button onclick="delP('${id}')" style="border:none; background:none; color:red; cursor:pointer; margin-left:10px;"><i class="fas fa-trash"></i></button>
                    </div>` : ""}
                </div>
                <div style="white-space:pre-wrap; margin-bottom:10px;">${d.t.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>')}</div>
                ${d.m ? `<img src="${d.m}" style="width:100%; border-radius:10px; margin-bottom:10px;">` : ""}
                <div class="actions">
                    <button class="act-btn ${d.likes?.includes(uid)?'active-l':''}" onclick="vote('${id}','l')"><i class="fas fa-thumbs-up"></i> ${d.likes?.length || 0}</button>
                    <button class="act-btn ${d.dislikes?.includes(uid)?'active-d':''}" onclick="vote('${id}','d')"><i class="fas fa-thumbs-down"></i> ${d.dislikes?.length || 0}</button>
                    <button class="act-btn" onclick="addCom('${id}')"><i class="fas fa-comment"></i> ${d.comments?.length || 0}</button>
                </div>
                ${comments ? `<div class="comment-sec">${comments}</div>` : ""}
            </div>`;
        }).join("");
    }

    window.vote = async (id, type) => {
        const r = doc(db, "messages", id), uid = auth.currentUser.uid, d = (await getDoc(r)).data();
        if(type === 'l') await updateDoc(r, { likes: d.likes.includes(uid) ? arrayRemove(uid) : arrayUnion(uid), dislikes: arrayRemove(uid) });
        else await updateDoc(r, { dislikes: d.dislikes.includes(uid) ? arrayRemove(uid) : arrayUnion(uid), likes: arrayRemove(uid) });
    };

    window.addCom = async (id) => {
        const t = prompt("Yorumunuz:");
        if(t) await updateDoc(doc(db, "messages", id), { comments: arrayUnion({ n: auth.currentUser.displayName, t }) });
    };

    window.searchUsers = async (v) => {
        const res = document.getElementById('search-results');
        if(v.length < 1) return res.classList.add('hidden');
        const sn = await getDocs(collection(db, "users"));
        const matches = sn.docs.map(d => d.data()).filter(u => u.username.includes(v.toLowerCase()));
        res.innerHTML = matches.map(u => `<div class="search-item" onclick="openUser('${u.username}')"><img src="${u.pic}" class="avatar"><b>@${u.username}</b></div>`).join("");
        res.classList.remove('hidden');
    };

    window.openUser = async (n) => {
        const u = (await getDoc(doc(db, "users", n))).data();
        document.getElementById('profile-pg').style.display='block';
        document.getElementById('p-av').src = u.pic;
        document.getElementById('p-un').innerHTML = "@"+u.username + (n === "admin" ? ' <i class="fas fa-check-circle admin-badge"></i>' : '');
        document.getElementById('p-bi').innerText = u.bio || "";
        const isMe = (n === auth.currentUser.displayName);
        document.getElementById('edit-btn').style.display = isMe ? 'inline-block' : 'none';
        document.getElementById('msg-btn').style.display = isMe ? 'none' : 'inline-block';
        document.getElementById('msg-btn').onclick = () => { activeChat = n; document.getElementById('chat-title').innerText = "@"+n; document.getElementById('chat-ui').style.display='flex'; loadMsgs(); };
        const pSn = await getDocs(query(collection(db, "messages"), where("n", "==", n)));
        renderPosts(pSn, "p-li");
    };

    function loadMsgs() {
        const rid = [auth.currentUser.displayName, activeChat].sort().join("_");
        onSnapshot(query(collection(db, "chats", rid, "messages"), orderBy("ts", "asc")), sn => {
            document.getElementById('chat-msgs').innerHTML = sn.docs.map(d => `<div class="${d.data().s === auth.currentUser.displayName ? 'm-me' : 'm-th'}">${d.data().t}</div>`).join("");
            document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
        });
    }

    window.sendMsg = async () => {
        const i = document.getElementById('chat-inp'), rid = [auth.currentUser.displayName, activeChat].sort().join("_");
        if(!i.value) return;
        await addDoc(collection(db, "chats", rid, "messages"), { t: i.value, s: auth.currentUser.displayName, ts: serverTimestamp() });
        i.value = "";
    };

    window.saveP = async () => {
        const pic = document.getElementById('ed-av-prev').src, bio = document.getElementById('ed-bio-inp').value;
        await updateDoc(doc(db, "users", auth.currentUser.displayName), { pic, bio });
        await updateProfile(auth.currentUser, { photoURL: pic });
        location.reload();
    };

    function updateTrends(sn) {
        const counts = {};
        sn.docs.forEach(doc => (doc.data().tags || []).forEach(tag => counts[tag] = (counts[tag] || 0) + 1));
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('trend-list').innerHTML = sorted.map(([tag, count]) => `<div class="trend-item"><b>${tag}</b><br><small style="color:var(--gray)">${count} payla≈üƒ±m</small></div>`).join("") || "Etiket yok.";
    }

    window.editP = async (id, old) => { const n = prompt("D√ºzenle:", old); if(n !== null && n !== old) await updateDoc(doc(db, "messages", id), { t: n }); };
    window.delP = async (id) => { if(confirm("Silmek istediƒüine emin misin?")) await deleteDoc(doc(db, "messages", id)); };
    window.prevImg = (i, f) => { const file = document.getElementById(f).files[0]; if(!file) return; const r = new FileReader(); r.onload = () => { document.getElementById(i).src = r.result; document.getElementById(i).style.display='block'; }; r.readAsDataURL(file); };
    window.openEdit = async () => { const u = (await getDoc(doc(db, "users", auth.currentUser.displayName))).data(); document.getElementById('ed-av-prev').src = u.pic; document.getElementById('ed-bio-inp').value = u.bio; document.getElementById('edit-pg').style.display = 'block'; };
    window.closeP = () => { document.getElementById('profile-pg').style.display='none'; document.getElementById('search-results').classList.add('hidden'); };
    window.closeEdit = () => document.getElementById('edit-pg').style.display='none';
</script>
</body>
</html>
