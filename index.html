<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nappag | Klasik Ruh Modern Akış</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --nappag-yellow: #FFDB5E; 
            --bg: #F5F1E6; 
            --maroon: #800000;
            --border: #D9BF55;
            --post-bg: #F0E0D6;
            --name-green: #117743;
            --blue: #34345C;
        }
        
        body { background: var(--bg); font-family: "Times New Roman", Times, serif; margin: 0; color: #1c1e21; overflow-x: hidden; }

        /* Nappag Navigasyon */
        nav { background: var(--nappag-yellow); border-bottom: 2px solid var(--border); height: 60px; display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-inner { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        
        /* Logo Alanı */
        .logo-box { border: 2px solid #000; padding: 5px 15px; background: #fff; box-shadow: 3px 3px 0px #000; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .logo-text { font-size: 24px; font-weight: bold; color: var(--maroon); text-transform: uppercase; font-family: sans-serif; }
        .robot-mini { width: 22px; height: 22px; background: var(--nappag-yellow); border: 1.5px solid #000; position: relative; }
        .robot-mini::before { content: '..'; position: absolute; top: -6px; left: 3px; font-weight: bold; font-size: 18px; }
        .robot-mini::after { content: ''; position: absolute; bottom: 4px; left: 4px; width: 12px; height: 1.5px; background: #000; }

        .main-layout { display: flex; max-width: 1000px; margin: 0 auto; gap: 20px; padding: 15px; }
        .feed-side { flex: 1; min-width: 0; }
        .right-side { width: 300px; position: sticky; top: 75px; height: fit-content; }
        @media (max-width: 800px) { .main-layout { flex-direction: column; } .right-side { width: 100%; } }

        /* Kart Yapıları */
        .card { background: var(--post-bg); border: 1px solid var(--border); padding: 15px; margin-bottom: 15px; box-shadow: 1px 1px 0px #fff inset; }
        .post-input-card { background: var(--nappag-yellow); border: 2px solid var(--border); }
        
        input, textarea { width: 100%; border: 1px solid var(--border); padding: 10px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; outline: none; background: #fff; }
        .btn-blue { background: #eee; border: 1px solid #999; color: #000; padding: 10px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-blue:hover { background: #ddd; border-color: #000; }
        
        /* Profil ve Hashtag */
        .avatar { width: 45px; height: 45px; border: 1.5px solid #000; object-fit: cover; cursor: pointer; background: #fff; }
        .admin-badge { color: var(--maroon); margin-left: 5px; font-size: 14px; }
        .hashtag { color: var(--maroon); font-weight: bold; cursor: pointer; text-decoration: underline; }
        .user-link { color: var(--name-green); font-weight: bold; text-decoration: none; }
        
        /* Aksiyonlar */
        .actions { display: flex; gap: 8px; border-top: 1px dotted #999; padding-top: 10px; margin-top: 10px; }
        .act-btn { flex: 1; background: #eee; border: 1px solid #999; padding: 6px; font-weight: bold; color: #444; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; font-family: inherit; }
        .act-btn.active-l { background: var(--name-green); color: white; }
        .act-btn.active-d { background: var(--maroon); color: white; }
        .comment-sec { background: rgba(0,0,0,0.05); border-left: 3px solid var(--border); padding: 10px; margin-top: 10px; font-size: 13px; }

        /* Search & Trends */
        .search-container { position: relative; margin-bottom: 15px; }
        #search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 100; border: 1px solid #000; box-shadow: 4px 4px 0px rgba(0,0,0,0.1); }
        .search-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .trend-item { padding: 8px; cursor: pointer; border-bottom: 1px dotted var(--border); }
        .trend-item:hover { background: var(--nappag-yellow); }

        /* Chat UI */
        #chat-ui { position: fixed; bottom: 0; right: 20px; width: 300px; height: 400px; background: var(--post-bg); border: 2px solid #000; box-shadow: 5px 5px 0px rgba(0,0,0,0.2); z-index: 3000; display: none; flex-direction: column; }
        .chat-header { background: var(--maroon); color: white; padding: 10px; display: flex; justify-content: space-between; font-weight: bold; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; font-size: 13px; }
        .m-me { background: var(--name-green); color: white; align-self: flex-end; padding: 6px 10px; border: 1px solid #000; max-width: 80%; }
        .m-th { background: #fff; color: black; align-self: flex-start; padding: 6px 10px; border: 1px solid #000; max-width: 80%; }

        /* Full Page Overlays */
        #profile-pg, #edit-pg { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="auth-pg" style="max-width:350px; margin: 100px auto; padding: 20px;">
    <div class="card post-input-card" style="text-align:center; border: 3px solid #000; box-shadow: 8px 8px 0px #000;">
        <h1 class="logo-text" style="font-size: 40px; margin-bottom: 20px;">NAPPAG</h1>
        <input type="text" id="u-name" placeholder="Rumuz">
        <input type="password" id="u-pass" placeholder="Şifre">
        <button class="btn-blue" onclick="handleAuth()">GİRİŞ / KAYDOL</button>
    </div>
</div>

<div id="main-pg" class="hidden">
    <nav>
        <div class="nav-inner">
            <div class="logo-box" onclick="location.reload()">
                <span class="logo-text">NAPPAG</span>
                <div class="robot-mini"></div>
            </div>
            <div onclick="openUser(auth.currentUser.displayName)" style="cursor:pointer; color:var(--maroon); font-weight:bold;">
                <i class="fas fa-user-circle"></i> PROFİLİM
            </div>
        </div>
    </nav>
    <div class="main-layout">
        <div class="feed-side">
            <div class="card post-input-card">
                <b style="color:var(--maroon)">Fikir Paylaş:</b>
                <textarea id="inp" placeholder="Neler oluyor?"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="file" id="f-up" class="hidden" onchange="prevImg('p-img', 'f-up')">
                    <label for="f-up" style="color:var(--blue); cursor:pointer; font-weight:bold; font-size:13px;">[<i class="fas fa-image"></i> Görsel Ekle]</label>
                    <button class="btn-blue" style="width:100px;" onclick="send()">PAYLAŞ</button>
                </div>
                <img id="p-img" style="width:100%; display:none; border:1px solid #000; margin-top:10px;">
            </div>
            <div id="posts-list"></div>
        </div>
        <div class="right-side">
            <div class="search-container">
                <input type="text" placeholder="Kullanıcı ara..." oninput="searchUsers(this.value)" style="margin:0; border:2px solid var(--border);">
                <div id="search-results" class="hidden"></div>
            </div>
            <div class="card">
                <h3 style="margin-top:0; color:var(--maroon); border-bottom: 2px solid #000;"><i class="fas fa-fire"></i> Gündem</h3>
                <div id="trend-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="profile-pg">
    <nav><div class="nav-inner"><div class="logo-box" onclick="closeP()"><span class="logo-text">← GERİ</span></div><b>PROFİL AYRINTILARI</b></div></nav>
    <div style="text-align:center; padding: 30px; border-bottom: 1px solid #000; background: var(--nappag-yellow);">
        <img id="p-av" class="avatar" style="width:120px; height:120px; border:4px solid #000">
        <h2 id="p-un" style="color:var(--maroon)"></h2><p id="p-bi"></p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="edit-btn" class="btn-blue" style="width:auto; padding:8px 20px;" onclick="openEdit()">Düzenle</button>
            <button id="msg-btn" class="btn-blue" style="width:auto; padding:8px 20px;">Mesaj At</button>
        </div>
    </div>
    <div id="p-li" class="container" style="max-width:600px; margin:20px auto;"></div>
</div>

<div id="edit-pg">
    <nav><div class="nav-inner"><div class="logo-box" onclick="closeEdit()"><span class="logo-text">✕ İPTAL</span></div><b>BİLGİLERİ DÜZENLE</b></div></nav>
    <div style="max-width:400px; margin: 20px auto; padding:20px;" class="card">
        <img id="ed-av-prev" class="avatar" style="width:100px; height:100px; display:block; margin:0 auto; border:2px solid #000;">
        <input type="file" id="f-av-edit" class="hidden" onchange="prevImg('ed-av-prev', 'f-av-edit')">
        <label for="f-av-edit" style="display:block; text-align:center; color:var(--maroon); margin:15px; cursor:pointer; font-weight:bold;">[Fotoğrafı Değiştir]</label>
        <textarea id="ed-bio-inp" placeholder="Yeni bio..."></textarea>
        <button class="btn-blue" onclick="saveP()">KAYDET</button>
    </div>
</div>

<div id="chat-ui">
    <div class="chat-header"><span id="chat-title">Mesajlar</span><button onclick="document.getElementById('chat-ui').style.display='none'" style="color:white; background:none; border:none; cursor:pointer;">✕</button></div>
    <div id="chat-msgs" class="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:5px; border-top: 1px solid #000;"><input type="text" id="chat-inp" style="margin:0;"><button onclick="sendMsg()" class="btn-blue" style="width:50px;">></button></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, setDoc, getDoc, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyBc1oohhXQFNr5QsoPG1VBc5lTMGaMoyos", authDomain: "nappag-8c527.firebaseapp.com", projectId: "nappag-8c527", storageBucket: "nappag-8c527.firebasestorage.app", messagingSenderId: "370496474734", appId: "1:370496474734:web:172774434cb14af279207f" };
    const app = initializeApp(cfg); const auth = getAuth(app); const db = getFirestore(app);
    let activeChat = null;

    onAuthStateChanged(auth, u => {
        document.getElementById('auth-pg').classList.toggle('hidden', u);
        document.getElementById('main-pg').classList.toggle('hidden', !u);
        if(u) {
            document.getElementById('inp').placeholder = `Neler oluyor ${u.displayName}?`;
            loadData();
        }
    });

    window.handleAuth = async () => {
        const n = document.getElementById('u-name').value.trim().toLowerCase(), p = document.getElementById('u-pass').value;
        if(!n || p.length < 6) return alert("Hata: Eksik bilgi veya kısa şifre.");
        try { await signInWithEmailAndPassword(auth, n+"@nappag.com", p); }
        catch {
            const r = await createUserWithEmailAndPassword(auth, n+"@nappag.com", p);
            const pic = `https://ui-avatars.com/api/?name=${n}&background=FFDB5E&color=800000`;
            await updateProfile(r.user, { displayName: n, photoURL: pic });
            await setDoc(doc(db, "users", n), { username: n, pic, bio: "Nappag kullanıcısı", ts: serverTimestamp() });
        }
    };

    window.send = async () => {
        const t = document.getElementById('inp').value, m = document.getElementById('p-img').src;
        if(!t && !m.includes('data')) return;
        const tags = t.match(/#\w+/g) || [];
        await addDoc(collection(db, "messages"), { t, n: auth.currentUser.displayName, p: auth.currentUser.photoURL, m: m.startsWith('data') ? m : "", ts: serverTimestamp(), likes: [], dislikes: [], comments: [], tags });
        document.getElementById('inp').value = ""; document.getElementById('p-img').style.display='none';
    };

    function loadData() {
        onSnapshot(query(collection(db, "messages"), orderBy("ts", "desc")), sn => {
            renderPosts(sn, "posts-list");
            updateTrends(sn);
        });
    }

    function renderPosts(sn, tid) {
        document.getElementById(tid).innerHTML = sn.docs.map(docSnap => {
            const d = docSnap.data(), id = docSnap.id, uid = auth.currentUser.uid;
            const isMe = (d.n === auth.currentUser.displayName);
            const badge = (d.n === "admin") ? '<i class="fas fa-check-circle admin-badge" title="Onaylı Admin"></i>' : '';
            const comments = (d.comments || []).map(c => `<div style="border-bottom: 1px dotted #ccc; padding: 2px 0;"><b>@${c.n}:</b> ${c.t}</div>`).join("");
            
            return `<div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openUser('${d.n}')">
                        <img src="${d.p}" class="avatar"> <b class="user-link">@${d.n}${badge}</b>
                    </div>
                    ${isMe ? `<div>
                        <button onclick="editP('${id}',\`${d.t}\`)" style="border:none; background:none; color:var(--maroon); cursor:pointer;"><i class="fas fa-edit"></i></button>
                        <button onclick="delP('${id}')" style="border:none; background:none; color:red; cursor:pointer; margin-left:10px;"><i class="fas fa-trash"></i></button>
                    </div>` : ""}
                </div>
                <div style="white-space:pre-wrap; margin-bottom:10px; font-size: 16px;">${d.t.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>')}</div>
                ${d.m ? `<img src="${d.m}" style="width:100%; border:1px solid #000; margin-bottom:10px;">` : ""}
                <div class="actions">
                    <button class="act-btn ${d.likes?.includes(uid)?'active-l':''}" onclick="vote('${id}','l')"><i class="fas fa-thumbs-up"></i> ${d.likes?.length || 0}</button>
                    <button class="act-btn ${d.dislikes?.includes(uid)?'active-d':''}" onclick="vote('${id}','d')"><i class="fas fa-thumbs-down"></i> ${d.dislikes?.length || 0}</button>
                    <button class="act-btn" onclick="addCom('${id}')"><i class="fas fa-comment"></i> ${d.comments?.length || 0}</button>
                </div>
                ${comments ? `<div class="comment-sec">${comments}</div>` : ""}
            </div>`;
        }).join("");
    }

    window.vote = async (id, type) => {
        const r = doc(db, "messages", id), uid = auth.currentUser.uid, d = (await getDoc(r)).data();
        if(type === 'l') await updateDoc(r, { likes: d.likes.includes(uid) ? arrayRemove(uid) : arrayUnion(uid), dislikes: arrayRemove(uid) });
        else await updateDoc(r, { dislikes: d.dislikes.includes(uid) ? arrayRemove(uid) : arrayUnion(uid), likes: arrayRemove(uid) });
    };

    window.addCom = async (id) => {
        const t = prompt("Yorumunuz:");
        if(t) await updateDoc(doc(db, "messages", id), { comments: arrayUnion({ n: auth.currentUser.displayName, t }) });
    };

    window.searchUsers = async (v) => {
        const res = document.getElementById('search-results');
        if(v.length < 1) return res.classList.add('hidden');
        const sn = await getDocs(collection(db, "users"));
        const matches = sn.docs.map(d => d.data()).filter(u => u.username.includes(v.toLowerCase()));
        res.innerHTML = matches.map(u => `<div class="search-item" onclick="openUser('${u.username}')"><img src="${u.pic}" class="avatar"><b>@${u.username}</b></div>`).join("");
        res.classList.remove('hidden');
    };

    window.openUser = async (n) => {
        const uDoc = await getDoc(doc(db, "users", n));
        if(!uDoc.exists()) return;
        const u = uDoc.data();
        document.getElementById('profile-pg').style.display='block';
        document.getElementById('p-av').src = u.pic;
        document.getElementById('p-un').innerHTML = "@"+u.username + (n === "admin" ? ' <i class="fas fa-check-circle admin-badge"></i>' : '');
        document.getElementById('p-bi').innerText = u.bio || "";
        const isMe = (n === auth.currentUser.displayName);
        document.getElementById('edit-btn').style.display = isMe ? 'inline-block' : 'none';
        document.getElementById('msg-btn').style.display = isMe ? 'none' : 'inline-block';
        document.getElementById('msg-btn').onclick = () => { activeChat = n; document.getElementById('chat-title').innerText = "@"+n; document.getElementById('chat-ui').style.display='flex'; loadMsgs(); };
        const pSn = await getDocs(query(collection(db, "messages"), where("n", "==", n)));
        renderPosts(pSn, "p-li");
    };

    function loadMsgs() {
        const rid = [auth.currentUser.displayName, activeChat].sort().join("_");
        onSnapshot(query(collection(db, "chats", rid, "messages"), orderBy("ts", "asc")), sn => {
            document.getElementById('chat-msgs').innerHTML = sn.docs.map(d => `<div class="${d.data().s === auth.currentUser.displayName ? 'm-me' : 'm-th'}">${d.data().t}</div>`).join("");
            document.getElementById('chat-msgs').scrollTop = document.getElementById('chat-msgs').scrollHeight;
        });
    }

    window.sendMsg = async () => {
        const i = document.getElementById('chat-inp'), rid = [auth.currentUser.displayName, activeChat].sort().join("_");
        if(!i.value) return;
        await addDoc(collection(db, "chats", rid, "messages"), { t: i.value, s: auth.currentUser.displayName, ts: serverTimestamp() });
        i.value = "";
    };

    window.saveP = async () => {
        const pic = document.getElementById('ed-av-prev').src, bio = document.getElementById('ed-bio-inp').value;
        await updateDoc(doc(db, "users", auth.currentUser.displayName), { pic, bio });
        await updateProfile(auth.currentUser, { photoURL: pic });
        location.reload();
    };

    function updateTrends(sn) {
        const counts = {};
        sn.docs.forEach(doc => (doc.data().tags || []).forEach(tag => counts[tag] = (counts[tag] || 0) + 1));
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('trend-list').innerHTML = sorted.map(([tag, count]) => `<div class="trend-item"><b>${tag}</b><br><small style="color:#666">${count} fikir</small></div>`).join("") || "Henüz gündem yok.";
    }

    window.editP = async (id, old) => { const n = prompt("Düzenle:", old); if(n !== null && n !== old) await updateDoc(doc(db, "messages", id), { t: n }); };
    window.delP = async (id) => { if(confirm("Silmek istediğine emin misin?")) await deleteDoc(doc(db, "messages", id)); };
    window.prevImg = (i, f) => { const file = document.getElementById(f).files[0]; if(!file) return; const r = new FileReader(); r.onload = () => { document.getElementById(i).src = r.result; document.getElementById(i).style.display='block'; }; r.readAsDataURL(file); };
    window.openEdit = async () => { const u = (await getDoc(doc(db, "users", auth.currentUser.displayName))).data(); document.getElementById('ed-av-prev').src = u.pic; document.getElementById('ed-bio-inp').value = u.bio; document.getElementById('edit-pg').style.display = 'block'; };
    window.closeP = () => { document.getElementById('profile-pg').style.display='none'; document.getElementById('search-results').classList.add('hidden'); };
    window.closeEdit = () => document.getElementById('edit-pg').style.display='none';
</script>
</body>
</html>
